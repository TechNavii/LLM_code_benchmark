name: Quality Gates

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Permissions for PR comments, check annotations, and dependency review
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Dependency Review - runs on PRs to detect vulnerable dependency changes
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on high and critical severity vulnerabilities
          fail-on-severity: high
          # Deny specific problematic licenses (optional, can be expanded)
          deny-licenses: GPL-3.0, AGPL-3.0
          # Only scan repository requirements files, not tasks/* workspace deps
          # The action scans manifest files changed in the PR
          # Use allow-paths to restrict scanning scope
          allow-paths: |
            server/requirements.txt
            server/requirements.in
            harness/requirements.txt
            harness/requirements.in
            requirements-dev.txt
            requirements-dev.in
          # Block PRs that introduce vulnerable dependencies
          comment-summary-in-pr: on-failure
          # Warn but don't fail on unknown licenses (brownfield-friendly)
          allow-unknown-licenses: true

  quality-checks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        # Enforce supported Python versions (defined in pyproject.toml: requires-python = ">=3.11")
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for diff-cover comparison
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Run ShellCheck on scripts
        run: ./scripts/shellcheck.sh

      - name: Check dependency lock files
        run: ./scripts/check-deps.sh

      - name: Run lint checks
        run: ./scripts/lint.sh

      - name: Run type checking
        run: ./scripts/typecheck.sh

      - name: Run tests with coverage (strict warnings)
        run: ./scripts/test.sh -W error::DeprecationWarning -W error::PendingDeprecationWarning
        env:
          CI: true

      - name: Run diff coverage analysis
        id: diff-cover
        if: github.event_name == 'pull_request'
        run: |
          # Generate diff-cover report in markdown format for PR comment
          # Brownfield-friendly: warn-only mode initially (DIFF_COVER_WARN_ONLY=true)
          # Set DIFF_COVER_FAIL_UNDER to enforce minimum coverage on changed lines
          DIFF_COVER_WARN_ONLY=true \
          DIFF_COVER_HTML=diff-cover.html \
          ./scripts/diff-cover.sh 2>&1 | tee diff-cover-output.txt

          # Extract summary for PR comment
          echo "## Diff Coverage Report (Python ${{ matrix.python-version }})" > diff-cover-summary.md
          echo "" >> diff-cover-summary.md
          # Extract coverage percentage from diff-cover output
          if grep -q "Diff Coverage:" diff-cover-output.txt; then
            grep "Diff Coverage:" diff-cover-output.txt >> diff-cover-summary.md
          else
            echo "No changed lines found in coverage scope." >> diff-cover-summary.md
          fi
          echo "" >> diff-cover-summary.md
          echo "<details>" >> diff-cover-summary.md
          echo "<summary>Full diff coverage output</summary>" >> diff-cover-summary.md
          echo "" >> diff-cover-summary.md
          echo '```' >> diff-cover-summary.md
          cat diff-cover-output.txt >> diff-cover-summary.md
          echo '```' >> diff-cover-summary.md
          echo "</details>" >> diff-cover-summary.md
        continue-on-error: true

      - name: Post diff coverage summary to PR
        if: github.event_name == 'pull_request' && matrix.python-version == '3.11'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the diff-cover summary
            let summary = '';
            try {
              summary = fs.readFileSync('diff-cover-summary.md', 'utf8');
            } catch (e) {
              summary = '## Diff Coverage Report\n\nNo diff coverage data available.';
            }

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Diff Coverage Report')
            );

            const body = summary + '\n\n---\n*Posted by Quality Gates CI*';

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload diff coverage report
        uses: actions/upload-artifact@v4
        if: github.event_name == 'pull_request'
        with:
          name: diff-cover-report-py${{ matrix.python-version }}
          path: |
            diff-cover.html
            diff-cover-output.txt
            diff-cover-summary.md
          retention-days: 7

      - name: Run security scan
        run: ./scripts/security-scan.sh

      - name: Run Bandit SAST scan
        run: ./scripts/bandit.sh

      - name: Run Semgrep security scan
        run: ./scripts/semgrep.sh

      - name: Run license compliance scan
        run: ./scripts/license-scan.sh

      - name: Generate SBOM
        run: ./scripts/sbom.sh

      - name: Validate OpenAPI schema
        run: ./scripts/openapi-validate.sh

      - name: Check for OpenAPI breaking changes
        run: ./scripts/openapi-diff.sh

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: .coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 7

      - name: Upload JUnit test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-results-py${{ matrix.python-version }}
          path: junit.xml
          retention-days: 7

      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-xml-py${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 7

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: junit.xml
          check_name: Test Results (Python ${{ matrix.python-version }})

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-py${{ matrix.python-version }}
          path: |
            docs/sbom/sbom.json
            docs/sbom/sbom.xml
          retention-days: 30
